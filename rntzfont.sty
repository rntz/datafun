%% Notes to myself:
%%
%% Sans-serifs to consider: noto, plex-sans[semibold], lato
%% Lato unfortunately lacks small caps.

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{rntzfont}[2018/07/02]
\RequirePackage{etoolbox}       % for \ifdefstring
\RequirePackage{xfp}            % multiplying scaling factors with \fpeval
\RequirePackage{xkeyval}        % key-value options

%% ---------- 1. Package options ----------
\DeclareOptionX{scaled}[1]{\edef\rntz@fontscale{#1}}
\DeclareOptionX{linespread}[1.1]{\edef\rntz@linespread{#1}}

%% serif font options
\DeclareOptionX{baskervald}{\def\rntz@font{baskervald}}
\DeclareOptionX{charter}{\def\rntz@font{charter}}
\DeclareOptionX{cochineal}{\def\rntz@font{cochineal}}
\DeclareOptionX{libertine}{\def\rntz@font{libertine}}
\DeclareOptionX{librebaskerville}{\def\rntz@font{librebaskerville}}
\DeclareOptionX{palatino}{\def\rntz@font{palatino}}
\DeclareOptionX{pt}{\def\rntz@font{pt}}
\DeclareOptionX{source}{\def\rntz@font{source}}

%% math font options
\DeclareOptionX{euler}{\def\rntz@mathfont{euler}}
\DeclareOptionX{newmath}{\def\rntz@mathfont{newmath}}
\DeclareOptionX{nomath}{\def\rntz@mathfont{none}}
\DeclareOptionX{pazo}{\def\rntz@mathfont{pazo}}

\ExecuteOptionsX{scaled,linespread,charter,euler} % default options
\ProcessOptionsX\relax                 % is \relax necessary here?


%% ---------- 2. Miscellany ----------
%% Utilities for scaling used inside this file.
\newcommand{\@scaled}[1]{\fpeval{#1*\rntz@fontscale}}
\edef\rntz@eulerscale{1}

%% Default linespread.
\linespread{\@scaled{\rntz@linespread}}

%% TO CONSIDER:
%\PassOptionsToPackage{euler-digits}{eulervm}
%\usepackage[full]{textcomp} % what does this do?

%% inconsolata[varqu] - Uses straight double & single quotes.
%% Other options I haven't used:
%% - varl makes l not vertical, ugh.
%% - var0 removes the slash in 0, which is less clear for code.
\PassOptionsToPackage{varqu}{inconsolata}

%% Options to new{tx,px}math:
%% vvarbb - A more readable variant blackboard bold.
%% smallerops - Vertically smaller \prod & \sum.
%%
%% To consider: bigdelims (enlarges "delimiters" - what are those? parens?)
%%
%% Font-family options to newtxmath:
%% baskerv{aldx,ille}, libertine, cochineal, utopia.
\PassOptionsToPackage{vvarbb,smallerops}{newtxmath}
\PassOptionsToPackage{vvarbb,smallerops}{newpxmath}

%% Load pazo as math font if selected. We load it first so its text font will
%% get replaced by the user's choice.
\ifdefstring{\rntz@mathfont}{pazo}{
  \RequirePackage{mathpazo}
  \ifdefstring{\rntz@fontscale}{1}{}{
    \PackageWarning{rntzfont}{Cannot scale Pazo font.}
  }
}


%% ---------- 3. Font choices ----------
\ifdefstring{\rntz@font}{baskervald}{
  \RequirePackage[proportional,osf,scaled=\@scaled{1.0526}]{Baskervaldx}
  \RequirePackage[p,osf,scaled=\@scaled{1.063126}]{biolinum}
  \RequirePackage[scaled=\@scaled{1.005}]{inconsolata}
  \ifdefstring{\rntz@mathfont}{newmath}{
    \RequirePackage[baskervaldx,scaled=\@scaled{1.0526}]{newtxmath}
  }{}
}{}

\ifdefstring{\rntz@font}{charter}{
  %% XCharter can be scaled. It has an option [osf] for old-style proportional
  %% figures, but lacks proportional lining figures, and so doesn't respect
  %% fontaxes' \tbfigures or \lnfigures.
  \RequirePackage[sups,scaled=\@scaled{1.02}]{XCharter}
  \RequirePackage[proportional,semibold,scaled=\@scaled{1.0074}]{sourcesanspro}
  \RequirePackage[scaled=\@scaled{1.075}]{inconsolata}
  %\edef\rntz@eulerscale{1.054782} % eyeballed
  %\edef\rntz@eulercasle{1.0618175} % multiplicative mean of the other two
  \edef\rntz@eulerscale{1.0689}   % calculated from fontdimen values
  \ifdefstring{\rntz@mathfont}{newmath}{
    \RequirePackage[xcharter,scaled=\@scaled{1.1075}]{newtxmath}
  }{}
}{}

\ifdefstring{\rntz@font}{cochineal}{
  \RequirePackage[p,osf,sups,scale=\@scaled{1.13}]{cochineal}
  \RequirePackage[p,osf,scaled=\@scaled{1.12}]{biolinum}
  \RequirePackage[scaled=\@scaled{1.0622}]{inconsolata}
  \edef\rntz@eulerscale{1.05}
  \ifdefstring{\rntz@mathfont}{newmath} {
    \RequirePackage[cochineal,scaled=\@scaled{1.13}]{newtxmath}
  }{}
}{}

\ifdefstring{\rntz@font}{libertine}{
  % libertine[osf] makes newtxmath use old-style figures in math mode :(
  % Other options: semibold.
  \RequirePackage[p,mono=false,llscale=\@scaled{1.0842},scale=\@scaled{1.0842}]
                 {libertine}
  \RequirePackage[scaled=\@scaled{1.02485}]{inconsolata}
  \edef\rntz@eulerscale{1.03}
  \ifdefstring{\rntz@mathfont}{newmath}{
    \RequirePackage[libertine,scaled=\@scaled{1.0842}]{newtxmath}
  }{}
}{}

\ifdefstring{\rntz@font}{librebaskerville}{
  \RequirePackage[scaled=\@scaled{0.8717815}]{librebaskerville}
  \RequirePackage[p,osf,scaled=\@scaled{1.063126}]{biolinum}
  \RequirePackage[scaled=\@scaled{1.005}]{inconsolata}
  \ifdefstring{\rntz@mathfont}{newmath}{
    \RequirePackage[libertine,scaled=\@scaled{1.063126}]{newtxmath}
  }{}
}{}

\ifdefstring{\rntz@font}{palatino}{
  \RequirePackage[scaled=\@scaled{1}]{newpxtext}
  \RequirePackage[scaled=\@scaled{1.067}]{biolinum}
  \RequirePackage[scaled=\@scaled{1.012}]{inconsolata}
  \ifdefstring{\rntz@mathfont}{newmath}{
    \RequirePackage[scaled=\@scaled{1}]{newpxmath}
    \PassOptionsToPackage{bb=ams,bbscaled=\@scaled{1}}{mathalfa}
  }{}
  %% HACK: newpxtext doesn't respect fontaxes' \tbfigures! :( but it _does_
  %% define, eg., \tlfstyle! hm...
  \RequirePackage{fontaxes}
  \renewcommand\tbfigures{}
  \renewcommand\lnfigures{}
}{}

\ifdefstring{\rntz@font}{pt}{
  \RequirePackage[scaled=\@scaled{0.995}]{PTSerif}
  \RequirePackage[scaled=\@scaled{0.995}]{PTSans}
  %% PTSans doesn't have small caps; could use biolinum or sourcesanspro instead.
  %\RequirePackage[scaled=1.135]{biolinum}
  \RequirePackage[scaled=\@scaled{1.1128}]{inconsolata}
  \edef\rntz@eulerscale{1.07}
  \ifdefstring{\rntz@mathfont}{newmath}{
    \RequirePackage[utopia,scaled=\@scaled{1.1313}]{newtxmath}
  }{}
}{}

\ifdefstring{\rntz@font}{source}{
  \ifdefstring{\rntz@mathfont}{newmath}{
    \PackageWarning{rntzfont}{%
Source Serif and newtxmath don't mix well. Consider euler or mathastext.}
    \RequirePackage[libertine,scaled=\@scaled{1.11}]{newtxmath}
  }{}
  %% I'd like to pass "osf" here, but it ends up using old-style figures in math
  %% mode, too (in both Euler & newmath). Argh.
  \RequirePackage[semibold,proportional,scaled=\@scaled{1}]{sourceserifpro}
  \RequirePackage[proportional,semibold,scaled=\@scaled{1}]{sourcesanspro}
  %% TODO: double-check this scaling.
  \RequirePackage[scaled=\@scaled{1.06}]{inconsolata}
  \edef\rntz@eulerscale{1.045}
}{}


%% ---------- 4. Final tweaks & cleanup ----------
%% Load euler as math alphabet if requested
\ifdefstring{\rntz@mathfont}{euler}{
  \RequirePackage{eulervm}
  \edef\zeu@Scale{\@scaled{\rntz@eulerscale}} % scale eulervm font.
  \PassOptionsToPackage{scaled=\zeu@Scale}{mathalfa}
}

%% Adjust calligraphic alphabet.
%% TODO: check scaling of \mathcal in example.tex!
%% Other options: cal={cm,stix,pxtx,boondoxo}.
\RequirePackage[cal=cm]{mathalfa}

%% Make sure \mathbold is defined.
\ifdefined\mathbold\else\newcommand\mathbold{\boldsymbol}\fi

%% undefine \@scaled
\let\@scaled\relax
