\documentclass{article}

\usepackage[margin=1in]{geometry}

\usepackage{datafun}

%% ---------- New commands
\newcommand{\hole}{[\,]}

%% type-annotated semilattice operatoins
\newcommand{\tforin}[2]{\bigvee_{#1}(#2)\ }
\newcommand{\tfix}[2]{\ms{fix}_{#1}２茼篼轶
\newcommand{\tfixle}[3]{\tfix{#1}{#2 \le #3}}

%% iteration forms, used in evalution of fix
\newcommand{\iter}[4]{\ms{iter}_{#1}({#2}; \bind{#3}#4)}
\newcommand{\iterstep}[5]{\ms{iter}_{#1}({#2}; {#3}; {\bind{#4}#5})}
\newcommand{\iterle}[5]{\ms{iter}_{{\le}#1}({#2}; {#3}; \bind{#4}{#5})}
\newcommand{\iterlestep}[6]{\ms{iter}_{{\le}#1}({#2}; {#3}; {#4}; \bind{#5}{#6})}

\newcommand{\step}{\mapsto}

%% \newcommand{\lr}[2]{#1 \models #2}
\newcommand{\lr}[2]{#1\mathrel{|}#2}
\newcommand{\steps}{\step^*}
\renewcommand{\land}{\text{and}}
\newcommand{\disc}[1]{\square{#1}}

%% ---------- End new commands


\begin{document}

\section{Structural operational semantics}

In our operational semantics we:
\begin{enumerate}
\item Assume an elaboration step which subscripts all semilattice operations
($\unit$, $\vee$, $\bigvee$, $\ms{fix}$) with their type.
\item Do not distinguish discrete from monotone variables, and write $x,y$ for
  arbitrary variables.
\item Ignore the types $\N$ and $\str$ and their corresponding expression forms.
\item Add \ms{iter}
expressions as intermediate forms ocurring in the evaluation of \ms{fix}.
\item Classify some expressions $e$ as values $v$, and add a value-form
  $\setlit{\vec{v}}$ for finite sets.
\end{enumerate}

\[\begin{array}{rccl}
  %% expressions
  \textsf{expressions} & e
  &\bnfeq& ... \pipe \unit_L \pipe e \vee_L e \pipe \tforin{L}{x \in e} e
  \pipe \tfix{\fineq{L}}{x}{e} \pipe \tfixle{\eq{L}}{x}{e}{e}\\
  &&& \iter{\eq{A}}{e}{x}{e} \pipe \iterstep{\eq{A}}{e}{e}{x}{e}
  \pipe \iterle{\eq{A}}{e}{e}{x}{e} \pipe \iterlestep{\eq{A}}{e}{e}{e}{x}{e}\\
  &&& \setlit{\vec{v}}
  \vspace{0.5em}\\
  %% values
  \textsf{values} & v,u,w
  &\bnfeq& \fn\bind{x} e \pipe (v, v) \pipe \ms{in}_i\; v
  \pipe \ms{true} \pipe \ms{false} \pipe \setlit{\vec{v}}
  \vspace{0.5em}\\
  %% contexts
  \textsf{contexts} & C
  &\bnfeq& \hole \pipe C\;e \pipe v\;C \pipe (C, e) \pipe (v, C) \pipe \ms{in}_i\;C
  \pipe \pi_i \; C\\
  &&& C \vee_L e \pipe v \vee_L C \pipe \tforin{L}{x \in C} e\\
  &&& \ifthen{C}{e}{e} \pipe \case{C}{a}{e}{a}{e}\\
  &&& \iter{\eq{A}}{C}{x}{e} \pipe \iterstep{\eq{A}}{v}{C}{x}{e}\\
  &&& \iterle{\eq{A}}{C}{e}{x}{e} \pipe \iterle{\eq{A}}{v}{C}{x}{e}
  \pipe \iterlestep{\eq{A}}{v}{v}{C}{x}{e}
\end{array}\]


\subsection{Equality and inequality}

First, we give rules for the judgments $v \le v : \eq{A}$ and $v = v : \eq{A}$:
\begin{mathpar}
  \infer{\ms{false} \le \ms{false} : 2}{}
  \and
  \infer{\ms{false} \le \ms{true} : 2}{}
  \and
  \infer{\ms{true} \le \ms{true} : 2}{}
  \and
  \infer{(v_1, u_1) \le (v_2, u_2) : \eq{A} \x \eq{B}}{
    v_1 \le v_2 : \eq{A} & u_1 \le u_2 : \eq{B}}
  \and
  \infer{\ms{in}_i\; v \le \ms{in}_i\; u : \eq{A}_1 + \eq{A}_2}{v \le u : \eq{A}_i}
  \and
  %% rules for set inequality
  \infer[\rn{\subseteq}]{\setlit{\vec{v_i}} \le \setlit{\vec{u_i}} : \Set{\eq{A}}}{
    \forall{v_i}\,\exists{u_j}\; (v_i = u_j : \eq{A})}
  \and
  \infer{v = u : \eq{A}}{v \le u : \eq{A} & u \le v : \eq{A}}
\end{mathpar}

To see these judgments are decidable, induct on the structure of the type
$\eq{A}$. The quantifiers in the premise of the rule $\rn{\subseteq}$ range over
finite domains, and thus pose no issue.
%% Since they are decidable we use their negations $v \not\le v : \eq{A}$, $v
%% \ne v : \eq{A}$ freely.

It is easy to see by induction on $\eq{A}$ that $v_1 \le v_2 : \eq{A}$ is
transitive in $v_i$. By construction it is also antisymmetric with respect to
$v_1 = v_2 : \eq{A}$.

%% It is also easy to show by induction on the typing judgment that for any
%% well-typed value $\vdash v : \eq{A}$, we can derive $v \le v : \eq{A}$.

%% From these it follows that $v_1 \le v_2 : \eq{A}$ forms a preorder on well-typed
%% values, and that $v_1 = v_2 : \eq{A}$ forms an equivalence relation on them.

\todo{We would like to say it is also reflexive on all well-typed values, but we
  don't have a typing judgment on values! We threw that away when we added new
  expressions to our language! Hm... but on \emph{equality types}, it should
  still work! If we need this property, should revisit this.}


\subsection{Evaluation rules}
We phrase our evaluation rules in terms of one-holed contexts $C$ and a
hole-filling operation $C[e]$ (omitted for brevity). \todo{(Who do we cite for
  this style of operational semantics?)} Only some one-holed contexts are
allowed, enforcing a call-by-value evaluation order.

%\pagebreak
\begin{mathpar}
\infer{C[e] \step C[e']}{e \step e'}
\end{mathpar}

\[
\begin{array}{ccl}
  \multicolumn{3}{c}{\textbf{$\beta$-reductions}}\\
  (\fn\bind{x}e_1) \; e_2 &\step& \sub{e_2/x} e_1\\
  \pi_i \; (v_1, v_2) &\step& v_i\\
  \case{\ms{in}_i\; v}{x}{e_1}{x}{e_2} &\step& \sub{v/x} e_i\\
  \ifthen{\ms{true}}{e_1}{e_2} &\step& e_1\\
  \ifthen{\ms{false}}{e_1}{e_2} &\step& e_2

  %% rules for unit
  \vspace{0.5em}\\
  \multicolumn{3}{c}{\textbf{Rules for }\unit}\\
  \unit_2 &\step& \ms{false}\\
  \unit_{L \x M} &\step& (\unit_L, \unit_M)\\
  \unit_{A \to L} &\step& \fn\bind{x} \unit_L\\
  \unit_{A \mto L} &\step& \fn\bind{x} \unit_L\\
  \unit_{\Set{A}} &\step& \{\}

  %% rules for \vee
  \vspace{0.5em}\\
  \multicolumn{3}{c}{\textbf{Rules for }\vee}\\
  \ms{false} \vee_2 v &\step& v\\
  \ms{true} \vee_2 v &\step& \ms{true}\\
  (v_1, v_2) \vee_{L \x M} (u_1, u_2) &\step& (v_1 \vee_L u_1, v_2 \vee_M u_2)\\
  v \vee_{A \to L} u &\step& \fn\bind{x} v\;x \vee_L u\;x\\
  v \vee_{A \mto L} u &\step& \fn\bind{x} v\;x \vee_L u\;x\\
  %% the rule we've all been waiting for
  \setlit{\vec{v}} \vee_{\Set{A}} \setlit{\vec{u}} &\step& \setlit{\vec{v}, \vec{u}}

  %% rules for \bigvee
  \vspace{0.5em}\\
  \multicolumn{3}{c}{\textbf{Rules for }\bigvee}\\
  \tforin{L}{x \in \{\}} e &\step& \unit_L\\
  \tforin{L}{x \in \setlit{v, \vec{u}}} e
  &\step& \sub{v/x} e \vee_L \tforin{L}{x \in \setlit{\vec{u}}} e

  %% rules for \ms{fix}
  \vspace{0.5em}\\
  \multicolumn{3}{c}{\textbf{Rules for \ms{fix} and \ms{iter}}}\\
  \tfix{\fineq{L}}{x}{e} &\step& \iter{\fineq{L}}{\unit_{\fineq{L}}}{x}{e}\\
  \iter{\eq{A}}{v}{x}{e} &\step& \iterstep{\eq{A}}{v}{\sub{v/x} e}{x}{e}\\
  \iterstep{\eq{A}}{v_1}{v_2}{x}{e}
  &\step& \begin{cases}
    v_1 & \text{if}鲞鲞苠覃笼苘荛翦螓苠覃笼鲞昌妪荇屮酐雉桢蝼轶妪苠钿汜箦簖苘ゥ蝓戾骘骈戾轸弪戾荇骈戾苠覃听暹荇镳妪荏翦穰荛翦蜢妍苠覃听暹荇镳荃铋暨苠覃听妪苘荛翦蜢妍苠覃笼鲞荇镳鳊妪荏翦穰茆彗轭汜箦簖荛翦蜢弩翦瘥苠覃笼鲞荇镳鳊荏踱霪妪妪荇屮酐殒莒鲞荇镳苠覃笼苘鲞荇镳荇屮酐雉桢蝼轶妪苠钿汜箦簖苘荛翦蜢弩翦瘥苠覃笼鲞荇镳鲞饼鲞昌妪荏翦穰茆彗轭汜箦簖鲞荇屮酐殒鲞鲞苠覃笼苘荛翦蜢妍苠覃笼鲞荇镳鲞昌妪荇屮酐雉桢蝼轶妪苠钿汜箦簖苠钿狎蜥茌荏邈糸镱田玳汜蝈灬糸镱簖体め猬悻娆绗瑜蜥铉秭弪沆矬邃屮痱弩箝镱螗犷戾ぼ眢藻蝽忮翳箦ゥ镦犰沆矬邃屮痱弩箝镱体ぼ玑眄岈荏殓磲蜥铉秭弪篚怏糸趱糸镱泔铘衢铋铉镱禊沆矬邃屮痱弩箝镱蟋犷戾ぼ眢敏ㄜ乔─忮翳箦镦犰篚怏糸趱糸镱镦沆矬邃屮痱弩箝镱骘翳鲠蜷徕戾轭ぼ乔ぎ荇镤稃幸下膛秃溟筱蝈翦鲠蜷徕戾轭泔铘屮趔语祯糸镱靠徜铄噜豉疱Ёぼ溟筱笼犷蝈痨徙溟筱蝈翦鲠蜷徕戾怡鲠蜷徕戾镦豉疱ぼ溟筱笼た族溴骈铄翳骘祆秣轭蝈灬糸镱蠛苒茆彗轭狎蜥沣祆莒螓笼莒恺Ζ荇屮酐溴骈铋糸镱玳鲥忮祜鼾苘莒螓芮驱茜犴磲莒荏殓磲荛骀苕矧犰歙茱荛芮签莒螓笼茜犴磲莒荏殓磲ㄜ翦酐骘螨茜犴磲荏殓磲荛茼篼敏ㄜ乔┅苘莒螓芮擒孱笼暹莒暹昌荛骀苕矧犰歙茜犴磲弑茜犴磲卟荛茼篼敏ㄜ乔┊莒螓芮驱茜犴磲弑莒茜犴磲卟苕矧犰歙爆博苘Ζ莒螓笼茜犴磲唛ㄥ弑莒茜犴磲唛ㄥ卟莒犷莒螓笼茜犴磲弑ㄥ唛莒茜犴磲卟ㄥ唛苠钿狎蜥茌物翦翳狒翳溴骈铋糸镱镦ぼ祢芮擒孱笼暹莒暹昌栳翳骘蝽镦泔眄豸轭篑踽蝈ㄡ祠栾蹒麇栳鲥铒弭箬秣翳狒翳弩蝈灬糸镱狎趄犷箝糸鲥犷翳弪彐矧泔眄豸濠荇镤稃轭箦螋溟徵蜥睚骑犷蝈灬糸镱ぼ祢佚莒邶が麇黩轸搴苒茆彗轭狎蜥沣忑莒螓佚邶荛骀莒螓佚莒邶莒犷莒螓佚莒冽苘莒螓佚冽荛骀莒螓佚冽苠钿狎蜥茌族铒玳鲥翳溴骈铋糸镱镦ぼ祢笼莒恺怡轭漉泗轱镱ちず苒茆彗轭狎蜥沣忑ゥ溟筱蝈翦铄篌泔盹钺莒螓茕轶沱笼莒恺荛骀莒螓笼恺苘ゥ怙镬遽铙莒螓昌莒恺荛骀荏翦痼莒犷荏翦痼莒犷莒曹ゥ篚眢莒螓吝吝昌莒恺荛骀荏翦痼茼篼轭唛芑莒犷荏翦痼茼篼轭唛芑莒犷莒螓吝辇莒觚苘ゥ痱镤蹉趔莒螓吝茗吝昌莒恺荛骀荏翦痼鲞爆鲞博莒犷荏翦痼踹爆踹博莒犷苕矧犰歙椹莒螓吝辇鲞莒踹辇苘ゥ箦趔莒螓苡弭笼莒恺荛骀荏翦痼荏弭扉酐荟邈鲞辇莒犷荏翦痼荏弭扉酐荟邈踹辇莒犷苕矧犰歙鲞椹芑苠轶趔踹戛莒螓笼鲞踹挲苘ゥ溟筱蝈翦骢钽糸镱莒螓荇慢莒恺荛骀莒螓茕轶沱笼茼麸慢莒恺苘ゥ盹铒麸铄骢钽糸镱莒螓茼麸慢莒琮荛骀荏翦痼苕钴忾钿暹莒犷荏翦痼苕钴忾钿暹莒犷ㄜ祢茱苠铘慢暹莒暹昌苠钿狎蜥茌荏踱箦泗轱铥藻蝽轭狒轱镦翦蝽轭翳祜玳汜蝈灬糸镱茆彗轭翳屣蝈睚涉ぼ祢笼猃翳孱め荏翦痼訾苠钿翳屣蝈睚茆彗轭痱镲纨蛮轭漉泗轱镱ち犷翳溴骈铋糸镱镦ぼ祢笼莒猃ぎ苠钿痱镲纨荏踱箦泗轱铥则犷箝糸鲩豉茆彗轭翳屣蝈睚墼蜥铙轸轹轸涉ぼ祢笼莒恺犷ぼ祢笼莒泯翳孱ぼ祢笼莒泯ぎ苠钿翳屣蝈睚茆彗轭痱镲纨蛮轭漉泗轱镱ちぎ茆彗轭溴筱蜷痿轱铨荛翦碹冕箦げぽ则轹獒怡趄犷箝糸鲩豉镦莒菠荛翦碹冕箦ぼ溟筱沥蛮扇铒糸铉翳狒殒ぼ祢笼莒恺轶趄犷箝糸鲥箫轶ぼ祢笼恺ぎ荛翦碹冕箦ち茗陇蛮扇狃痨殄痫轭赭轶瀹荇镤稃骒弩秕酏荛翦碹冕箦ち陇蛮扇荇镤稃骒弩秕酏荛翦碹冕箦ぼ渝酐笼ぽ族栳鲥め荏翦痼荏弭扉酐荟邈踹辇がも荏翦痼荏弭扉酐荟邈鲞辇が犷ゃ荏翦痼荏弭扉酐荟邈鬟辇ぎ族鏖箬麸箬秣ぼ骘蜥祆踹椹墁苠轶趔鬟氅墁莒螓笼踹鬟氅ぎ蔑铙殇弪犷踹椁澡孱ぼ屮轶趔鲞戛墁莒螓笼踹鲞戛ぎ澡孱ぼ屮轶趔鬟氅墁莒螓笼鲞鬟氅ぎ澡躞怡扇ぼ祢笼踹鬟臊ぎ荛翦碹冕箦ち荇陇冕箦殓铒蝈忮汜躞麇趄犷箪狒狩狴ち荇陇荛翦碹冕箦ち茼麸陇族栳鲥め荏翦痼苕钴忾钿暹堡も荏翦痼苕钴忾钿暹菠犷ゃ荏翦痼茆轭潲暹长族栳鲥ぼ祢茱笼暹莒暹昌犷ぼ祢茱笼暹莒暹除犷麇鏖箬麸箬秣翳狒ぼ祢茱苠铘慢暹莒暹除ぎ蔑铙殇弪犷ぼ玑眄徇爆茜犴磲卟荛茼篼敏茱俩篚汨翳狒ぼ祢茱笼茜犴磲弑莒茜犴磲卟ぎ澡孱翳骘祆秣轭溟徵蜥泔眄豸弩怡翳趄犷箝糸鲩豉镦ぼ祢慢莒恺麒殂骘祆秣骝镯扇┖荇镤稃轭箦螋溟徵蜥睚苠钿溴筱蜷痿轱铨苠钿痱镲纨荏踱箦泗轱铥嗅螋獒蝈骒屮轹轸茆彗轭翳屣蝈睚坌狎糸犰蝈骒屮轹轸涉ぼ祢笼莒恺翳孱ぼ祢笼莒猃ㄡ钿翳弪彐矧ぼ祢笼猃ぉ苠钿翳屣蝈睚茆彗轭痱镲纨蛮轭漉泗轱镱ちぎ茆彗轭溴筱蜷痿轱铨荛翦碹冕箦ぼ溟筱笼ぽ乞镯ぼ祢茕轶沱笼莒恺麇栳鲥ぼ祢笼恺犷翳躞ぼ祢笼莒恺ぎ蛮扇ぼ祢笼莒猃が犷箫ぼ祢笼猃ぎ澡躞ぼ祢茕轶沱笼莒猃ぎ荛翦碹冕箦げぽ蛮蝈骒屮轹轸镦莒菠镱ぼ茼篼趄蹂茼篼驷祗妪荦ぎ荛翦碹冕箦ち茗陇蛮扇狃痨殄痫轭赭轶瀹荇镤稃骒弩秕酏荛翦碹冕箦ち陇蛮扇荇镤稃骒弩秕酏荛翦碹冕箦ち荃麸陇社铒蝈浠麇趄犷箪狒ち荃麸陇轭麸ぼ溟筱笼茼麸陇荛翦碹冕箦ち茼麸陇乞镯ぼ祢茼麸慢莒恺麇栳鲥め荏翦痼苕钴忾钿澶犷も荏翦痼苕钴忾钿濮ぎ蔑铙殇弪犷ぼ玑眄徇爆茜犴磲卟荛茼篼敏茱俩篚汨翳狒ぼ祢茱笼茜犴磲弑莒茜犴磲卟ぎ澡孱狃痨轭ぼ祢茼麸慢莒恺麇栳鲥茆彗轭轸屙辁妪荛翦ぼ祢慢茜犴磲弑ㄥ莒茜犴磲卟ㄥせ荛翦ぼ祢慢茜犴磲唛ㄥ莒茜犴磲唛ㄥЗが犷箫怡秕扇狒ぢ麇栳鲥ぼ祢慢茜犴磲唛ㄥ莒茜犴磲唛ㄥ苠钿轸屙辁妪麒殂骘蝽翳泔眄豸轭篑踽蝈麇铄邃苠钿溴筱蜷痿轱铨苠钿痱镲纨荏踱箦泗轱铥蔑铉蝓孱沐秭弪ぼ篝屦茆彗轭翳屣蝈睚涉ぼ祢笼猃犷め荏翦猡翳孱ぼ祢笼恺ぎ苠钿翳屣蝈睚荇镤稃韵南痱镲纨荏踱箦泗轱铥契钿犴孱翎翳屣蝈睚茴鬻泔眄犷潲茔溟筱郾蓰茕轶沱１吴ぼ泺溟筱苣屐翎轶翳镳弪狒轱麒殂蝈痨徙弩遽汨茱荛苣屐翎鏖翳茱茕轶沱笼ぎ茆彗轭翳屣蝈睚涉ぼ悄卉乔荟溽箬沥翳孱ぼ祢茔溟筱芮凝芮苠铘笼妪ぎ苠钿翳屣蝈睚茆彗轭痱镲纨蛮轭漉泗轱镱ぼ悄卉乔荟溽箬沥茆彗轭溴筱蜷痿轱铨荛翦碹冕箦筝ぼ轭驽蜊茯酐鲠螨蓰芮幕芮荟溽箬茱笼茱荛芮凝がぼ轭驽蜊茯酐鲠螨瞢蓰芮幕芮荟溽箬茼茱笼茼茱荛芮驱蛮溴骈铋糸镱镦ぼ祢茔溟筱芮凝芮驱茜犴磲弑莒茜犴磲卟ぎ荛翦碹冕箦ぼ轭驽蜊茼篼趄蹂蓰芮幕芮擒孱茼篼趄蹂昌ぼ祢昌茼篼趄蹂が轭溴邃ゥ荛翦碹冕箦ぼ轭驽蜊茼篼驷祗妪蓰芮幕芮擒孱茼篼驷祗妪昌ゥ茉夏荛翦碹冕箦ぼ轭驽蜊苕钷蓰芮幕芮苠铘苕钴忾钿茼茼麸慢芮幕芮躯茼茱苠铘慢杂ぼ祢茔溟筱芮凝芮苠铘茼麸慢苕钴忾钿茼妪苠钿溴筱蜷痿轱铨苠钿痱镲纨苠钿滹沲礤铘