%% ---- Semantics in a Datafun Model ----
\begin{figure*}
  \textsc{type and context denotations}

  %% TODO: revert to this more readable version if space allows.
  \begin{align*}
    \den{\tunit} &= \termO & \den{A \to B} &= \expO{\den{A}}{\den{B}}
    \\
    \den{\tseteq A} &= \pfinof{\den{\eqt A}}
    & \den{A \x B} &= \den{A} \x \den{B}
    \\
    \den{\iso A} &= \iso{\den{A}} & \den{A + B} &= \den{A} + \den{B}
  \end{align*}

  %% \begin{align*}
  %%   \den{\tunit} &= \termO
  %%   & \den{\tseteq A} &= \pfinof{\den{\eqt A}}
  %%   & \den{\iso A} &= \iso{\den{A}}
  %%   \\
  %%   \den{A \to B} &= \expO{\den{A}}{\den{B}}
  %%   & \den{A \x B} &= \den{A} \x \den{B}
  %%   & \den{A + B} &= \den{A} + \den{B}
  %% \end{align*}

  \begin{align*}
    \den{\G} &= \prod_{H \in \G} \den{H} &
    \den{\h x A} &= \den{A} & \den{\hd x A} &= \iso{\den{A}} &
    \den{\G \vdash A} &= \Poset(\den\G, \den A)
  \end{align*}
%  \vspace{0pt} % yes, this matters.

  \textsc{term denotations}

  \begin{displaymath}
    \def\arraystretch{1.15}
    \begin{array}{lcl}
      \den{\J {\dvar x} \G A} &=& \pi_{\dvar x} \then \varepsilon \qquad \text{(for $\hd x A \in \G$)} \\
      \den{\J x \G A} &=& \pi_x \qquad\quad\, \text{(for $\h x A \in \G$)} \\
      \den{\J {\fnof x e} \G {A \to B}} &=& \lambda\den{\J e {\G, \h x A} B} \\
      \den{\J {f\<e} \G B} &=& \fork{\den{\J f \G {A \to B}}, \den{\J e \G A}} \then \eval \\
      \den{\J {\etuple{e_1, e_2}} \G {A_1 \times A_2}} &=&
           \fork{\den{\J {e_1} \G {A_1}}, \den{\J {e_2} \G {A_2}}} \\
      \den{\J {\pi_i\<e} \G {A_i}} &=& \den{\J e \G {A_1 \times A_2}} \then \pi_i \\
      \den{\J {\ebox e} \G {\iso A}} &=& \mkbox_\Gamma(\den {\J e {\stripcx \G} A}) \\
      \den{\J {\elet{\ebox x = e} f} \G B} &=&  \fork{\id_\Gamma, \den{\J e \G {\iso A}}} \then \den{\J f {\G, \hd x A} B}  \\
      \den{\J \bot \G L} &=& !_\Gamma \then \morph{join}^L_0 \\
      \den{\J {e \vee f} \G L} &=& \fork{\den{\J e \G L}, \den{\J f \G L}} \then \morph{join}^L_2 \\
      \den{\J {\eisempty e} \G {1+1}}&=& \mkbox_\Gamma(\den{\J e {\stripcx \G} {\tset A}}) \then \morph{isEmpty} \\
      \den{\J {\esplit e} \G {\iso A + \iso B}} &=& \den{\J e \G {\iso(A + B)}}\then \isosum \\

      \den{\eeq{e_1}{e_2}} &=&
          \fork{\mkbox_\Gamma(\den{\J {e_1} {\stripcx \G} A}),
                \mkbox_\Gamma(\den{\J {e_2} {\stripcx \G} A})}
          \then \morph{eq} \\
      \den{\J {\efix e} \G L} &=& \den{\J e \G {\iso(L \to L)}} \then \morph{fix} \\

      \den{\esetsub{e_i}{i}} &=& \fork{\mkbox_\Gamma(\den{\J {e_1} {\stripcx \G} A}) \then \morph{singleton}}_i \then \morph{join}^L \\

      \den{\J {\efor x e f} \G L} &=&    \fork{\id,\den{\J e \G {\tset A}}} \then \pcollect{\den{\J f {\G, \hd x A} L}} \\
    \den{\J {\inj i e} \G {A_1 + A_2}} &=& \den{\J e \G {A_i}} \then \injc_i \\
    \den{\J {\ecase{e} (\inj i{x_i} \caseto f_i)_i} \G B} &=&
    \fork{\id, \den{\J e \G {A_1 + A_2}}} \then \morph{dist}^\x_+ \then
           \bigkrof{\den{\J {f_i} {\G, \h {x_i} {A_i}} B}}_i \\
    \end{array}
  \end{displaymath}
  \vspace{0pt} % yes, this matters

  \textsc{auxilliary operations}

  \begin{align*}
    \morph{dist}^\x_+ &~:~ A \x (B_1 + B_2) \to (A \x B_1) + (A \x B_2)
    &
    \mkbox_\Gamma &~:~ \Poset(\den{\stripcx \G}, A) \to \Poset(\den{\G}, \iso A) \\
    % this could be simpler if it distributed in the opposite direction.
    \morph{dist}^\x_+ &= \fork{\pi_2 \then \krof{\lambda (\fork{\pi_2,\pi_1} \then \injc_i)}_i, \pi_1}
    \then \eval
    &
    \mkbox_\Gamma(f) &= \fork{\pi_{\dvar x} \then \delta}_{\hd x A \in \G} \then \isox \then \iso(f)
  \end{align*}


  \begin{displaymath}
    \begin{array}{ll}
      \begin{array}{lcl }
        \morph{join}^{L}_0 & : & 1 \to L \\
        \morph{join}^1_0 & = & !_{1} \\ 
        \morph{join}^{L_1 \times L_2}_2 & = & \fork{\morph{join}^{L_1}_0, \morph{join}^{L_2}_0} \\ 
        \morph{join}^{\pfinof A}_0 & = & \morph{join}^{\pfinof A}_0 \\[1em]
      \end{array} 
      \qquad &
      \begin{array}{lcl}
        \morph{join}^{L}_2 & : & L \times L \to L \\
        \morph{join}^1_2 & = & !_{1 \times 1} \\ 
        \morph{join}^{L_1 \times L_2}_2 & = & \alpha_{L_1, L_2} \then \morph{join}^{L_1}_2 \times \morph{join}^{L_2}_2 \\
        \morph{join}^{\pfinof A}_2 & = & \morph{join}^{\pfinof A}_2 \\ 
      \end{array}
    \end{array}
  \end{displaymath}
  \begin{displaymath}
    \begin{array}{lcl}
      \alpha_{L,M} & : & (L \times M) \times (L \times M) \to (L \times L) \times (M \times M) \\ 
      \alpha_{L,M} & = & ((l_1, m_1), (l_2, m_2)) \mapsto ((l_1, l_2), (m_1, m_2)) 
    \end{array}
  \end{displaymath}

  \caption{Semantics of Datafun}
  \label{fig:semantics}\label{def:strip}
\end{figure*}
