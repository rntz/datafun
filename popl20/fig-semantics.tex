%% ---- Semantics in a Datafun Model ----
\begin{figure*}
  \textsc{Type and Context Interpretations}

  \begin{align*}
    \den{\tunit} &= \termO & \den{A \to B} &= \expO{\den{A}}{\den{B}}
    \\
    \den{\tseteq A} &= \pfinof{\den{\eqt A}}
    & \den{A \x B} &= \den{A} \x \den{B}
    \\
    \den{\iso A} &= \discof{\den{A}} & \den{A + B} &= \den{A} + \den{B}
  \end{align*}

  \begin{align*}
    \den{\G} &= \prod_{H \in \G} \den{H} &
    \den{\h x A} &= \den{A} & \den{\hd x A} &= \discof{\den{A}} &
    \den{\G \vdash A} &= \catC(\den\G, \den A)
  \end{align*}
  \vspace{0pt} % yes, this matters.

  \textsc{Term Interpretation}
  \begin{displaymath}
    \begin{array}{lcl}
      \den{\J {\dvar x} \G A} &=& \pi_{\dvar x} \then \varepsilon \quad \text{($\hd x A \in \G$)} \\
      \den{\J x \G A} &=& \pi_x \quad \quad\, \text{($\h x A \in \G$)} \\
      \den{\J {\fnof x e} \G {A \to B}} &=& \lambda\den{\J e {\G, \h x A} B} \\
      \den{\J {f\<e} \G B} &=& \fork{\den{\J f \G {A \to B}}, \den{\J e \G A}} \then \eval \\
      \den{\J {\etuple{e_1, e_2}} \G {A_1 \times A_2}} &=& 
           \fork{\den{\J {e_1} \G {A_1}}, \den{\J {e_2} \G {A_2}}} \\
      \den{\J {\pi_i\<e} \G {A_i}} &=& \den{\J e \G {A_1 \times A_2}} \then \pi_i \\
      \\
      \bigden{\J {\ebox e} \G {\iso A}} &=& \mkbox_\Gamma(\den {\J e {\stripcx \G} A}) \\
      \bigden{\J {\elet{\ebox x = e} f} \G B} &=&  \fork{\id_\Gamma, \den{\J e \G {\iso A}}} \then \den{\J f {\G, \hd x A} B}  \\
      \den{\J \bot \G L} &=& \termI \then \morph{join}^L_0 \\
  
      \den{\J {e \vee f} \G L} &=& \fork{\den{\J e \G L}, \den{\J f \G L}} \then \morph{join}^L_2 \\
  
      %\den{\color{red}\prim{isEmpty}\<e} &= \den{e} \then \morph{isEmpty}
      \den{\J {\eisempty e} \G {1+1}}&=& \mkbox_\Gamma(\den{\J e {\stripcx \G} {\tset A}}) \then \morph{isEmpty} \\
      \den{\J {\esplit e} \G {\iso A + \iso B}} &=& \den{\J e \G {\iso(A + B)}}\then \discosum \\
  
      %\den{\color{red}\prim{eq}\<e} &= \den{e} \then \morph{eq}
      \den{\eeq{e_1}{e_2}} &=& 
          \fork{\mkbox_\Gamma(\den{\J {e_1} {\stripcx \G} A}), 
                \mkbox_\Gamma(\den{\J {e_2} {\stripcx \G} A})}
          \then \morph{eq} \\
      \den{\J {\efix e} \G L} &=& \den{\J e \G {\iso(L \to L)}} \then \morph{fix} \\
  
      %\den{\edown e} &= \den{e} \then \morph{gen} % <- THIS IS WRONG
      \den{\eset{e_i}_i} &=& \fork{\mkbox_\Gamma(\den{\J {e_1} {\stripcx \G} A}) \then \morph{singleton}}_i \then \morph{join}^L \\
  
      \den{\J {\efor x e f} \G L} &=&    \fork{\id,\den{\J e \G {\tset A}}} \then \pcollect{\den{\J f {\G, \hd x A} L}} \\
    \den{\J {\inj i e} \G {A_1 + A_2}} &=& \den{\J e \G {A_i}} \then \injc_i \\
    \den{\J {\ecase{e} (\inj i{x_i} \caseto f_i)_i} \G B} &=&
    \fork{\id, \den{\J e \G {A_1 + A_2}}} \then \morph{dist}^\x_+ \then 
           \bigkrof{\den{\J {f_i} {\G, \h {x_i} {A_i}} B}}_i \\
    \end{array}
  \end{displaymath}
  \vspace{0pt} % yes, this matters

  \textsc{Auxilliary Operations}

  \begin{align*}
    \morph{dist}^\x_+ &: A \x (B_1 + B_2) \to (A \x B_1) + (A \x B_2)\\
    % this could be simpler if it distributed in the opposite direction.
    \morph{dist}^\x_+ &= \fork{\pi_2 \then \krof{\lambda (\fork{\pi_2,\pi_1} \then \injc_i)}_i, \pi_1}
    \then \eval
    \\[1ex]
    \strip_\Gamma &: \den\G \to \discof{\den{\stripcx\G}}\\
    \strip_\Gamma &= \fork{\pi_{\dvar x} \then \delta}_{\hd x A \in \G} \then \discox
    \\[1ex]
    \mkbox_\Gamma &: \Poset(\den{\stripcx \G}, A) \to \Poset(\den{\G}, \iso A) \\
    \mkbox_\Gamma(f) &= \strip_\Gamma \then \iso(f) 
  \end{align*}


  %% \raggedright\footnotesize Strictly speaking, the cases for
  %% $\den{\eset{e_i}_i}$, $\den{\eisempty e}$, and $\den{\eeq e f}$ are not
  %% structurally inductive; nonetheless $\den{e}$ is well-defined.

  \caption{Semantics of Core Datafun}
  \label{fig:semantics}\label{def:strip}
\end{figure*}
