\section{Proving the Semi\naive\ Transformation Correct}

We formalize the intended behavior of $\phi e$ and $\delta e$ using a logical
relation.
%
Inductively on types $A$, given $a,b : \den{A}$,
$x,y : \den{\Phi A}$, and $\dx : \den{\DP A}$, we define
$\weirdat{A}{\dx}{x}{a}{y}{b}$ by:
%to be the relation generated by the inference rules:

\begin{align*}
  \weirdat{\tunit}{\tuple{}}{\tuple{}}{\tuple{}}{\tuple{}}{\tuple{}}
  &\iff \top
  \\
  \weirdat{\tseteq A}{\dx}{x}{a}{y}{b}
  &\iff (x,y,x \cup \dx) = (a,b,y)
  \\
  \weirdat{\iso A}{\tuple{}}{(x,\dx)}{a}{(y,\dy)}{b}
  &\iff (a,x,\dx) = (b,y,\dy) \wedge \weirdat{A}{\dx}{x}{a}{y}{b}
  \\
  \weirdat{A_1 \x A_2}{\vec{\dx}}{\vec x}{\vec a}{\vec y}{\vec b}
  &\iff \fa{i} \weirdat{A_i}{\dx_i}{x_i}{a_i}{y_i}{b_i}
  \\
  \weirdat{A_1 + A_2}{\inj i \dx}{\inj j x}{\inj k a}{\inj l y}{\inj m b}
  &\iff i = j = k = l = m \wedge \weirdat{A_i}{\dx}{x}{a}{y}{b}
  \\
  \weirdat{A \to B}{\df}{f}{f_s}{g}{g_s}
  &\iff
  \fa{\weirdat{A}{\dx}{x}{a}{y}{b}}\\
  &\hphantom{{}\iff{}}
  \weirdat{B}{\df\<x\<\dx}{f\<x}{f_s\<a}{g\<y}{g_s\<b}
  \\
  \weirdat{\G}{\dgamma}{\g}{\rho}{\g'}{\rho'}
  &\iff \XXX
\end{align*}

\begin{theorem}[Fundamental]
  If $\J e \G A$ and $\weirdat{\G}{\dgamma}{\g}{\rho}{\g'}{\rho'}$ then
  \[\weirdat{A}{\den{\delta e} \<\tuple{\g,\dgamma}}{\den{\phi
      e}\<\g}{\den{e}\<\rho}{\den{\phi e}\<\g'}{\den{e}\<\rho'}\]
\end{theorem}

\noindent
It's easy to show inductively that at eqtypes, $\weirdat{\eqt
  A}{\dx}{x}{a}{y}{b}$ implies $x = a$. Consequently:

\begin{corollary}[First-order Correctness]
  If $\J e {\emptycx} {\eqt A}$ then $\den{e} = \den{\phi e}$.
\end{corollary}

%% \nopagebreak[2]
%% \vspace{-\baselineskip}
%% \begin{mathpar}
%%   \weirdat{\tunit}{\tuple{}}{\tuple{}}{\tuple{}}{\tuple{}}{\tuple{}}

%%   \weirdat{\tseteq A}{\dx}{x}{x}{x \cup \dx}{x \cup \dx}

%%   \infer{\weirdat{A}{\dx}{x}{a}{x}{a}}{
%%     \weirdat{\iso A}{\tuple{}}{(x,\dx)}{a}{(x,\dx)}{a}}

%%   \infer{\fa{i} \weirdat{A_i}{\dx_i}{x_i}{a_i}{y_i}{b_i}}{
%%     \weirdat{A_1 \x A_2}{\vec{\dx}}{\vec x}{\vec a}{\vec y}{\vec b}}

%%   \infer{\weirdat{A_i}{\dx}{x}{a}{y}{b}}{
%%     \weirdat{A_1 + A_2}{\inj i \dx}{\inj i x}{\inj i a}{\inj i y}{\inj i b}}

%%   \infer{\fa{\weirdat{A}{\dx}{x}{a}{y}{b}}
%%     \weirdat{B}{\df\<x\<\dx}{f\<x}{f_s\<a}{g\<y}{g_s\<b}
%%   }{
%%     \weirdat{A \to B}{\df}{f}{f_s}{g}{g_s}}
%% \end{mathpar}
